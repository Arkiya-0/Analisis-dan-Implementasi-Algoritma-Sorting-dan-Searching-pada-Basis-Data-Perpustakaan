#include <iostream>
#include <vector>
#include <string>
#include <algorithm>
#include <fstream>
using namespace std;

struct Book {
    string isbn;
    string author;
    int tahun;
    string judul;
    string genre;
    string rak;
};

//data
vector<Book> libraryDB = {
    {"978-602-8803-19-1", "Andrea Hirata", 2005, "Laskar Pelangi", "Roman", "A1"},
    {"978-979-9731-27-2", "Pramoedya Ananta Toer", 1980, "Bumi Manusia", "Sejarah", "A1"},
    {"978-602-412-518-9", "Henry Manampiring", 2018, "Filosofi Teras", "Filsafat", "B2"},
    {"978-979-3062-79-2", "Tere Liye", 2015, "Rindu", "Roman", "C3"}
};

string currentUser;
string favGenre;

//log
void writeLog(const string &action) {
    ofstream logFile("system_log.txt", ios::app);
    if (logFile.is_open()) {
        logFile << "[USER: " << currentUser << "] ACTION: " << action << endl;
    }
}

//search eng
void searchBook() {
    int choice;
    cout << "\n=== MENU SEARCH ===\n";
    cout << "1. Cari berdasarkan Judul\n";
    cout << "2. Cari berdasarkan Author\n";
    cout << "3. Cari berdasarkan Genre\n";
    cout << "4. Cari berdasarkan Genre Favorit Anda\n";
    cout << "Pilihan: ";
    cin >> choice;
    cin.ignore();

    string key;
    if (choice != 4) {
        cout << "Masukkan kata kunci: ";
        getline(cin, key);
    } else {
        key = favGenre;
        cout << "Mencari berdasarkan genre favorit: " << key << endl;
    }

    bool found = false;

    cout << "\n=== HASIL PENCARIAN ===\n";

    for (auto &b : libraryDB) {
        string target;
        if (choice == 1) target = b.judul;
        else if (choice == 2) target = b.author;
        else if (choice == 3) target = b.genre;
        else if (choice == 4) target = b.genre;
        else return;

        if (target.find(key) != string::npos) {
            cout << "\nISBN  : " << b.isbn << endl;
            cout << "Judul : " << b.judul << endl;
            cout << "Author: " << b.author << endl;
            cout << "Tahun : " << b.tahun << endl;
            cout << "Genre : " << b.genre << endl;
            cout << "Rak   : " << b.rak << endl;
            found = true;
        }
    }

    if (!found) cout << "Tidak ada buku yang cocok.\n";

    writeLog("Search Book: " + key);
}

//list buku
void listAllBooks() {
    cout << "\n=== SEMUA BUKU ===\n";
    for (auto &b : libraryDB) {
        cout << "\nISBN  : " << b.isbn << endl;
        cout << "Judul : " << b.judul << endl;
        cout << "Author: " << b.author << endl;
        cout << "Tahun : " << b.tahun << endl;
        cout << "Genre : " << b.genre << endl;
        cout << "Rak   : " << b.rak << endl;
    }
    writeLog("List All Books");
}

//Sorting
void sortingMenu() {
    int c;
    cout << "\n=== MENU SORTING ===\n";
    cout << "1. Sort Judul (A-Z)\n";
    cout << "2. Sort Tahun (Terlama â†’ Terbaru)\n";
    cout << "3. Sort Author (A-Z)\n";
    cout << "Pilihan: ";
    cin >> c;

    if (c == 1) {
        sort(libraryDB.begin(), libraryDB.end(), 
            [](Book a, Book b){ return a.judul < b.judul; });
    }
    else if (c == 2) {
        sort(libraryDB.begin(), libraryDB.end(),
            [](Book a, Book b){ return a.tahun < b.tahun; });
    }
    else if (c == 3) {
        sort(libraryDB.begin(), libraryDB.end(),
            [](Book a, Book b){ return a.author < b.author; });
    }
    else return;

    cout << "\nSorting selesai!\n";
    writeLog("Sorting executed");
}

//filt tahun
void filterTahun() {
    int minYear;
    cout << "Tampilkan buku dari tahun >= ";
    cin >> minYear;

    cout << "\n=== HASIL FILTER ===\n";

    bool found = false;
    for (auto &b : libraryDB) {
        if (b.tahun >= minYear) {
            cout << "\n" << b.judul << " (" << b.tahun << ")" << endl;
            found = true;
        }
    }

    if (!found) cout << "Tidak ada buku dengan tahun tersebut.\n";

    writeLog("Filter Tahun >= " + to_string(minYear));
}

//menu
void menu() {
    int pilihan;
    do {
        cout << "\n=== MENU UTAMA ===\n";
        cout << "1. Pencarian Buku\n";
        cout << "2. List Semua Buku\n";
        cout << "3. Sorting Buku\n";
        cout << "4. Filter Tahun Buku\n";
        cout << "5. Keluar\n";
        cout << "Pilihan: ";
        cin >> pilihan;
        cin.ignore();

        switch (pilihan) {
        case 1: searchBook(); break;
        case 2: listAllBooks(); break;
        case 3: sortingMenu(); break;
        case 4: filterTahun(); break;
        case 5:
            cout << "Keluar...\n";
            writeLog("Logout");
            break;
        }
    } while (pilihan != 5);
}

//login
int main() {
    cout << "===== SISTEM PERPUSTAKAAN C++ =====\n";
    
    cout << "Masukkan username: ";
    getline(cin, currentUser);

    cout << "Masukkan genre favorit Anda: ";
    getline(cin, favGenre);

    writeLog("Login User");

    menu();
    return 0;
}
